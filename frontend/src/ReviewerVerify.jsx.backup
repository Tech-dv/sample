import { useState, useEffect } from "react";
import { useParams, useNavigate, useSearchParams } from "react-router-dom";
import AppShell from "./AppShell";
import approvedTick from "./assets/approved_tick.png";
import { API_BASE } from "./api";


import {
  cardStyles,
  fieldStyles,
  inputStyles,
  tableStyles,
  buttonGroupStyles,
  getButtonStyle,
  getInputStyle,
} from "./styles";

/* ================= MULTIPLE RAKE SERIAL CONFIRMATION POPUP ================= */
function MultipleRakeSerialPopup({ open, onClose, onYes, onNo }) {
  if (!open) return null;

  return (
    <div style={confirmPopupStyles.overlay}>
      <div style={confirmPopupStyles.modal}>
        <div style={confirmPopupStyles.header}>
          Confirm Rake Serial No.
        </div>
        <div style={confirmPopupStyles.body}>
          <p style={confirmPopupStyles.question}>
            Multiple Rake Serial Number Required?
          </p>
          <div style={confirmPopupStyles.buttonGroup}>
            <button style={confirmPopupStyles.button} onClick={onYes}>
              Yes
            </button>
            <button style={confirmPopupStyles.button} onClick={onNo}>
              No
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

/* ================= DRAFT SAVE POPUP ================= */
function DraftSavePopup({ open, onClose }) {
  const [countdown, setCountdown] = useState(3);

  useEffect(() => {
    if (!open) return;

    setCountdown(5);

    const interval = setInterval(() => {
      setCountdown((prev) => prev - 1);
    }, 1000);

    const timer = setTimeout(() => {
      onClose();
    }, 5000);

    return () => {
      clearInterval(interval);
      clearTimeout(timer);
    };
  }, [open, onClose]);

  if (!open) return null;

  return (
    <div style={popupStyles.overlay}>
      <div style={popupStyles.modal}>
        <img
          src={approvedTick}
          alt="Draft Saved"
          style={popupStyles.image}
        />

        <h2 style={popupStyles.title}>Draft Saved</h2>

        <p style={popupStyles.message}>
          Your changes have been saved successfully.
        </p>

        {/* ✅ COUNTDOWN TEXT */}
        <p style={{ fontSize: "13px", color: "#777", marginBottom: "18px" }}>
          Redirecting in {countdown} second{countdown !== 1 ? "s" : ""}
        </p>

        <button style={popupStyles.button} onClick={onClose}>
          OK
        </button>
      </div>
    </div>
  );
}

function FloatingField({ label, value, onChange, readOnly }) {
  return (
    <div style={floatingField.wrapper}>
      <div style={floatingField.label}>{label}</div>
      <input
        value={value}
        readOnly={readOnly}
        onChange={(e) => onChange && onChange(e.target.value)}
        style={floatingField.input}
      />
    </div>
  );
}

function BoxedField({ label, value, onChange, readOnly, isSelect, children }) {
  return (
    <div style={boxedFieldStyles.wrapper}>
      <div style={boxedFieldStyles.label}>{label}</div>

      {isSelect ? (
        <select
          value={value}
          onChange={(e) => onChange(e.target.value)}
          style={boxedFieldStyles.select}
        >
          {children}
        </select>
      ) : (
        <input
          value={value}
          readOnly={readOnly}
          onChange={(e) => onChange && onChange(e.target.value)}
          style={boxedFieldStyles.input}
        />
      )}
    </div>
  );
}



function TrainEdit() {
  const { trainId } = useParams();
  const [searchParams] = useSearchParams();
  const indentNumber = searchParams.get('indent_number');
  const navigate = useNavigate();
  const role = localStorage.getItem("role");
  const [showDraftPopup, setShowDraftPopup] = useState(false);
  const [showMultipleRakePopup, setShowMultipleRakePopup] = useState(false);

  /* ================= EDIT OPTIONS FROM POPUP ================= */
  const [editOptions, setEditOptions] = useState({
    singleIndent: true,
    wagonTypeHL: false
  });

  /* ================= TRACK IF SERIALS ALREADY SPLIT ================= */
  const [hasSequentialSerials, setHasSequentialSerials] = useState(false);

  /* ================= HELPER: Format DateTime ================= */
  const formatDateTime = (dateTimeString) => {
    if (!dateTimeString) return "-";
    try {
      const date = new Date(dateTimeString);
      
      // Get date parts
      const month = date.getMonth() + 1; // 1-12
      const day = date.getDate(); // 1-31
      const year = date.getFullYear();
      
      // Get time parts
      let hours = date.getHours();
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      
      // Determine AM/PM
      const ampm = hours >= 12 ? 'pm' : 'am';
      hours = hours % 12;
      hours = hours ? hours : 12; // Convert 0 to 12
      
      // Format: 7/1/2026, 11:08:21 am
      return `${month}/${day}/${year}, ${hours}:${minutes}:${seconds} ${ampm}`;
    } catch (e) {
      return "-";
    }
  };


  /* ================= CUSTOMERS ================= */
  const [customers, setCustomers] = useState([]);

  useEffect(() => {
    if (role !== "ADMIN") return;

    fetch(`${API_BASE}/customers`, {
      headers: { "x-user-role": "ADMIN" },
    })
      .then((res) => res.json())
      .then(setCustomers)
      .catch(console.error);
  }, [role]);

  /* ================= SAVE STATE ================= */
  const [isSaved, setIsSaved] = useState(false);

  /* ================= TRAIN HEADER ================= */
  const [trainHeader, setTrainHeader] = useState({
    indent_number: "",
    customer_id: "",
    wagon_destination: "", // ✅ fetched only
  });


  /* ================= WAGONS ================= */
  const [wagons, setWagons] = useState([]);

  function createEmptyWagon(index) {
    return {
      wagon_number: "",
      wagon_type: editOptions.wagonTypeHL ? "HL" : "",  // Pre-fill with HL if option enabled
      cc_weight: "",
      sick_box: "",
      wagon_to_be_loaded: "",
      commodity: "",
      tower_number: index,
      loaded_bag_count: 0,
      unloaded_bag_count: 0,
      loading_start_time: "",
      loading_end_time: "",
      seal_numbers: [""],
      stoppage_time: "",
      remarks: "",
      loading_status: false,
      // Fields for multiple indent mode - use values from trainHeader
      indent_number: !editOptions.singleIndent ? (trainHeader.indent_number || "") : "",
      wagon_destination: !editOptions.singleIndent ? (trainHeader.wagon_destination || "") : "",
      customer_id: !editOptions.singleIndent ? (trainHeader.customer_id || "") : "",
    };
  }

  const smallActionBtn = {
    padding: "4px 8px",
    fontSize: "11px",
    lineHeight: "1",
    minHeight: "26px",
  };


  /* ================= LOAD EXISTING DATA ================= */
  useEffect(() => {
    const loadTrainData = async () => {
      try {
        // Build URL with indent_number query parameter if provided
        const url = indentNumber
          ? `${API_BASE}/train/${trainId}/edit?indent_number=${encodeURIComponent(indentNumber)}`
          : `${API_BASE}/train/${trainId}/edit`;
        
        const res = await fetch(url);
        if (!res.ok) return;

        const data = await res.json();

        // Load edit options from database or localStorage (fallback)
        const storedOptions = localStorage.getItem('editOptions');
        const dbOptions = {
          singleIndent: data.header.single_indent !== undefined ? data.header.single_indent : true,
          wagonTypeHL: data.header.hl_only !== undefined ? data.header.hl_only : false
        };
        
        // Use DB values if available, otherwise use localStorage, otherwise defaults
        const finalOptions = data.header.indent_number
          ? dbOptions  // If indent filled, use DB values
          : (storedOptions ? JSON.parse(storedOptions) : dbOptions);  // Otherwise try localStorage
        
        setEditOptions(finalOptions);
        
        // Load the flag for whether this train has already been split
        setHasSequentialSerials(data.header.has_sequential_serials || false);
        
        // Clear localStorage after using it
        localStorage.removeItem('editOptions');

        setTrainHeader({
          indent_number: data.header.indent_number || "",
          customer_id: data.header.customer_id
            ? String(data.header.customer_id)
            : "",
          commodity: data.header.commodity || "",
          wagon_destination: data.header.wagon_destination || "",
        });

        if (data.wagons?.length) {
          setWagons(
            data.wagons.map((w, i) => ({
              ...w,
              // If wagonTypeHL option is true, set wagon_type to "HL", otherwise use existing value
              wagon_type: finalOptions.wagonTypeHL ? "HL" : (w.wagon_type || ""),
              sick_box: w.sick_box ? "Yes" : "No",
              loading_status: Boolean(w.loading_status),
              tower_number: i + 1,
              seal_numbers: w.seal_number 
                ? w.seal_number.split(",").map(s => s.trim()).filter(Boolean)
                : [""],
            }))
          );
        } else {
          // No wagons found - create empty wagon with correct indent_number from header
          const emptyWagon = {
            wagon_number: "",
            wagon_type: finalOptions.wagonTypeHL ? "HL" : "",
            cc_weight: "",
            sick_box: "",
            wagon_to_be_loaded: "",
            commodity: "",
            tower_number: 1,
            loaded_bag_count: 0,
            unloaded_bag_count: 0,
            loading_start_time: "",
            loading_end_time: "",
            seal_numbers: [""],
            stoppage_time: "",
            remarks: "",
            loading_status: false,
            // Fields for multiple indent mode - use values from header
            indent_number: !finalOptions.singleIndent ? (data.header.indent_number || "") : "",
            wagon_destination: !finalOptions.singleIndent ? (data.header.wagon_destination || "") : "",
            customer_id: !finalOptions.singleIndent ? (data.header.customer_id ? String(data.header.customer_id) : "") : "",
          };
          setWagons([emptyWagon]);
        }
      } catch (err) {
        console.error("Failed to load train data", err);
      }
    };

    loadTrainData();
  }, [trainId, indentNumber]);

  /* ================= WAGON HANDLERS ================= */
  const addWagon = () => {
    const newWagon = createEmptyWagon(wagons.length + 1);
    // Ensure new wagon has correct indent_number if in multiple indent mode
    if (!editOptions.singleIndent && trainHeader.indent_number) {
      newWagon.indent_number = trainHeader.indent_number;
      newWagon.wagon_destination = trainHeader.wagon_destination || "";
      newWagon.customer_id = trainHeader.customer_id || "";
    }
    setWagons([...wagons, newWagon]);
    setIsSaved(false);
  };

  const updateWagon = (index, field, value) => {
    // Fields that always cascade to rows below
    let cascadeFields = [
      "wagon_type",
      "cc_weight",
      "sick_box",
      "wagon_to_be_loaded",
      "commodity",
    ];

    // In single indent mode, wagon_destination cascades from header
    // In multiple indent mode, indent_number, wagon_destination, and customer_id cascade
    if (editOptions.singleIndent) {
      cascadeFields.push("wagon_destination");
    } else {
      // Multiple indent mode: these fields cascade when filled in table
      cascadeFields.push("indent_number");
      cascadeFields.push("wagon_destination");
      cascadeFields.push("customer_id");
    }

    const updated = wagons.map((w, i) => {
      // always update current row
      if (i === index) {
        return { ...w, [field]: value };
      }

      // copy value to rows BELOW (only for cascade fields)
      if (cascadeFields.includes(field) && i > index) {
        return { ...w, [field]: value };
      }

      return w;
    });

    setWagons(updated);
    setIsSaved(false);
  };
  const toggleStatus = async (index) => {
    const updated = [...wagons];
    const wagon = updated[index];

    const newStatus = !wagon.loading_status;
    wagon.loading_status = newStatus;

    setWagons(updated);
    setIsSaved(false);

    try {
      await fetch(
        `${API_BASE}/wagon/${trainId}/${wagon.tower_number}/status`,
        {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            loading_status: newStatus,
          }),
        }
      );
    } catch (err) {
      console.error("Failed to toggle wagon status", err);
    }
  };

  /* ================= SEAL NUMBER HANDLERS ================= */
  const addSealNumber = (wagonIndex) => {
    const updated = [...wagons];
    updated[wagonIndex].seal_numbers.push("");
    setWagons(updated);
    setIsSaved(false);
  };

  const updateSealNumber = (wagonIndex, sealIndex, value) => {
    const updated = [...wagons];
    updated[wagonIndex].seal_numbers[sealIndex] = value;
    setWagons(updated);
    setIsSaved(false);
  };

  const removeSealNumber = (wagonIndex, sealIndex) => {
    const updated = [...wagons];
    if (updated[wagonIndex].seal_numbers.length > 1) {
      updated[wagonIndex].seal_numbers.splice(sealIndex, 1);
      setWagons(updated);
      setIsSaved(false);
    }
  };

  /* ================= DUPLICATE WAGON ================= */
  const duplicateWagon = (index) => {
    const source = wagons[index];

    const duplicated = {
      ...source,

      // reset fields that must be unique
      wagon_number: "",
      wagon_type: editOptions.wagonTypeHL ? "HL" : source.wagon_type,  // Ensure HL if option enabled
      seal_numbers: [""],
      loading_start_time: "",
      loading_end_time: "",
      loaded_bag_count: 0,
      unloaded_bag_count: 0,
    };

    const updated = [...wagons];
    updated.splice(index + 1, 0, duplicated);

    // reassign tower numbers
    const withTower = updated.map((w, i) => ({
      ...w,
      tower_number: i + 1,
    }));

    setWagons(withTower);
    setIsSaved(false);
  };

  /* ================= DELETE WAGON ================= */
  const deleteWagon = (index) => {
    if (wagons.length === 1) {
      alert("At least one wagon is required");
      return;
    }

    const updated = wagons.filter((_, i) => i !== index);

    const withTower = updated.map((w, i) => ({
      ...w,
      tower_number: i + 1,
    }));

    setWagons(withTower);
    setIsSaved(false);
  };

  /* ================= SAVE DRAFT ================= */
  const saveDraft = async (showPopup = true) => {
    try {
      const wagonsWithHeader = wagons.map(w => ({
        ...w,
        // In single indent mode, use trainHeader values
        // In multiple indent mode, use wagon-level values
        wagon_destination: editOptions.singleIndent 
          ? trainHeader.wagon_destination 
          : (w.wagon_destination || ""),
        indent_number: editOptions.singleIndent 
          ? trainHeader.indent_number 
          : (w.indent_number || ""),
        customer_id: editOptions.singleIndent 
          ? (trainHeader.customer_id ? Number(trainHeader.customer_id) : null)
          : (w.customer_id ? Number(w.customer_id) : null),
        commodity: w.commodity || null,
        seal_number: w.seal_numbers.filter(s => s.trim()).join(", "),
      }));

      const res = await fetch(`${API_BASE}/train/${trainId}/draft`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-user-role": "ADMIN",
        },
        body: JSON.stringify({
          header: {
            ...trainHeader,
            customer_id: editOptions.singleIndent && trainHeader.customer_id
              ? Number(trainHeader.customer_id)
              : null,
          },
          wagons: wagonsWithHeader,
          editOptions: {
            singleIndent: editOptions.singleIndent,
            wagonTypeHL: editOptions.wagonTypeHL,
          },
        }),
      });

      if (!res.ok) return false;

      setIsSaved(true);

      if (showPopup) {
        setShowDraftPopup(true);
      }

      return true;
    } catch (err) {
      console.error("Save draft failed", err);
      return false;
    }
  };



  /* ================= PROCEED ================= */
  const proceed = async () => {
    const ok = await saveDraft(false);
    if (!ok) return;

    // If multiple indent mode, check if already split
    if (!editOptions.singleIndent) {
      // If this train has already been split into sequential serials, skip popup
      if (hasSequentialSerials) {
        console.log("Train already split into sequential serials, skipping popup");
        navigate(`/train/${trainId}/dispatch`);
        return;
      }
      
      // Not split yet - show popup
      setShowMultipleRakePopup(true);
      return;
    }

    // Single indent mode - proceed normally
    navigate(`/train/${trainId}/dispatch`);
  };

  /* ================= HANDLE MULTIPLE RAKE SERIAL RESPONSES ================= */
  const handleMultipleRakeYes = async () => {
    setShowMultipleRakePopup(false);
    
    try {
      // Get distinct indent numbers from wagons
      const indentNumbers = [...new Set(wagons.map(w => w.indent_number).filter(Boolean))];
      
      if (indentNumbers.length === 0) {
        alert("No indent numbers found. Please fill indent numbers in wagons.");
        return;
      }

      // Call backend to generate sequential serial numbers
      const res = await fetch(`${API_BASE}/train/${trainId}/generate-multiple-rake-serial`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-user-role": "ADMIN",
        },
        body: JSON.stringify({
          indentNumbers: indentNumbers,
        }),
      });

      if (!res.ok) {
        const error = await res.json();
        alert(`Failed to generate serial numbers: ${error.message || "Unknown error"}`);
        return;
      }

      const data = await res.json();
      
      // Navigate to dispatch page with the first serial number (the one with loading records)
      navigate(`/train/${data.firstSerialNumber}/dispatch`);
    } catch (err) {
      console.error("Error generating multiple rake serial numbers:", err);
      alert("Failed to generate serial numbers. Please try again.");
    }
  };

  const handleMultipleRakeNo = () => {
    setShowMultipleRakePopup(false);
    // Use same rake serial number - proceed normally
    navigate(`/train/${trainId}/dispatch`);
  };

  return (
    <AppShell>
      <div style={{ backgroundColor: "#FFFFFF", minHeight: "100vh", padding: "0" }}>

      {/* ================= HEADER CARD ================= */}
      <div style={{
        backgroundColor: "#FFFFFF",
        borderRadius: "6px",
        padding: "20px",
        margin: "20px 20px 20px",
      }}>
        <div style={topGridStyles.container}>
          {/* Show these fields only in single indent mode */}
          {editOptions.singleIndent && (
            <>
          <FloatingField
            label="Rake Serial Number"
            value={trainId}
            readOnly
          />

          <BoxedField
            label="Indent Number"
            value={trainHeader.indent_number}
            onChange={(v) =>
              setTrainHeader({ ...trainHeader, indent_number: v })
            }
          />

          <BoxedField
            label="Wagon Destination"
            value={trainHeader.wagon_destination}
            onChange={(v) =>
              setTrainHeader({ ...trainHeader, wagon_destination: v })
            }
          />

          {role === "ADMIN" && (
            <BoxedField
                  label="Party / Customer's Name"
              value={trainHeader.customer_id}
              onChange={(v) =>
                setTrainHeader({ ...trainHeader, customer_id: v })
              }
              isSelect
            >
              <option value="">Select Customer</option>
              {customers.map((c) => (
                <option key={c.id} value={c.id}>
                  {c.customer_name}
                </option>
              ))}
            </BoxedField>
              )}
            </>
          )}
        </div>
      </div>


      {/* ================= WAGON TABLE ================= */}
      <div style={{
        backgroundColor: "#FFFFFF",
        borderRadius: "6px",
        padding: "20px",
        margin: "0 20px 20px",
      }}>
        <div
          className="wagon-table-scrollable"
          style={{
            overflowX: "auto",
            overflowY: "auto",
            maxHeight: "calc(100vh - 450px)",
            minHeight: "400px",
            border: "1px solid #e0e0e0",
            borderRadius: "4px",
          }}
        >
          <table style={wagonTableStyles.container}>
            <thead>
              <tr>
                {/* Conditional columns for multiple indent mode */}
                {!editOptions.singleIndent && (
                  <>
                    <th style={wagonTableStyles.header}>Indent Number</th>
                    <th style={wagonTableStyles.header}>Wagon Destination</th>
                    {role === "ADMIN" && <th style={wagonTableStyles.header}>Party / Customer's Name</th>}
                  </>
                )}
                {/* Standard columns */}
                {[
                  "Wagon Number",
                  "Wagon Type",
                  "CC Weight (Tons)",
                  "Sick Box",
                  "Bags To Be Loaded",
                  "Commodity",
                  "Tower Number",
                  "Loaded Bag Count",
                  "Unloaded Bag Count",
                  "Loading Start Date & Time",
                  "Loading End Date & Time",
                  "Seal Number",
                  "Stoppage / Downtime",
                  "Remarks",
                  "Loading Completed",
                ].map((h) => (
                  <th key={h} style={wagonTableStyles.header}>{h}</th>
                ))}
              </tr>
            </thead>

            <tbody>
              {wagons.map((w, i) => (
                <tr key={i} style={wagonTableStyles.row(i)}>
                  {/* Conditional columns for multiple indent mode */}
                  {!editOptions.singleIndent && (
                    <>
                      <td style={wagonTableStyles.cell}>
                        <input
                          value={w.indent_number || ""}
                          onChange={(e) =>
                            updateWagon(i, "indent_number", e.target.value)
                          }
                          style={wagonTableStyles.input}
                        />
                      </td>
                      <td style={wagonTableStyles.cell}>
                        <input
                          value={w.wagon_destination || ""}
                          onChange={(e) =>
                            updateWagon(i, "wagon_destination", e.target.value)
                          }
                          style={wagonTableStyles.input}
                        />
                      </td>
                      {role === "ADMIN" && (
                        <td style={wagonTableStyles.cell}>
                          <select
                            value={w.customer_id || ""}
                            onChange={(e) =>
                              updateWagon(i, "customer_id", e.target.value)
                            }
                            style={wagonTableStyles.select}
                          >
                            <option value="">Select Customer</option>
                            {customers.map((c) => (
                              <option key={c.id} value={c.id}>
                                {c.customer_name}
                              </option>
                            ))}
                          </select>
                        </td>
                      )}
                    </>
                  )}
                  
                  <td style={wagonTableStyles.cell}>
                    <input
                      value={w.wagon_number}
                      onChange={(e) =>
                        updateWagon(i, "wagon_number", e.target.value)
                      }
                      style={wagonTableStyles.input}
                    />
                  </td>

                  <td style={wagonTableStyles.cell}>
                    <select
                      value={w.wagon_type}
                      onChange={(e) =>
                        updateWagon(i, "wagon_type", e.target.value)
                      }
                      style={wagonTableStyles.select}
                    >
                      <option value="">Select</option>
                      <option value="HL">HL</option>
                      <option value="BOX">BOX</option>
                    </select>
                  </td>

                  <td style={wagonTableStyles.cell}>
                    <input
                      value={w.cc_weight}
                      onChange={(e) =>
                        updateWagon(i, "cc_weight", e.target.value)
                      }
                      style={wagonTableStyles.input}
                    />
                  </td>

                  <td style={wagonTableStyles.cell}>
                    <select
                      value={w.sick_box}
                      onChange={(e) =>
                        updateWagon(i, "sick_box", e.target.value)
                      }
                      style={wagonTableStyles.select}
                    >
                      <option value="">Select</option>
                      <option value="Yes">Yes</option>
                      <option value="No">No</option>
                    </select>
                  </td>

                  <td style={wagonTableStyles.cell}>
                    <input
                      value={w.wagon_to_be_loaded}
                      onChange={(e) =>
                        updateWagon(i, "wagon_to_be_loaded", e.target.value)
                      }
                      style={wagonTableStyles.input}
                    />
                  </td>

                  <td style={wagonTableStyles.cell}>
                    <input
                      value={w.commodity}
                      onChange={(e) =>
                        updateWagon(i, "commodity", e.target.value)
                      }
                      style={wagonTableStyles.input}
                    />
                  </td>

                  <td style={wagonTableStyles.readOnlyCell}>{w.tower_number}</td>
                  <td style={wagonTableStyles.readOnlyCell}>{w.loaded_bag_count}</td>
                  <td style={wagonTableStyles.readOnlyCell}>{w.unloaded_bag_count}</td>
                  <td style={wagonTableStyles.readOnlyCell}>{formatDateTime(w.loading_start_time)}</td>
                  <td style={wagonTableStyles.readOnlyCell}>{formatDateTime(w.loading_end_time)}</td>

                  <td style={{...wagonTableStyles.cell, padding: "8px", position: "relative"}}>
                    <div style={{ 
                      display: "flex", 
                      flexDirection: "column", 
                      gap: "4px",
                      paddingBottom: "28px"
                    }}>
                      {w.seal_numbers.map((seal, sealIdx) => (
                        <div key={sealIdx} style={{ display: "flex", gap: "4px", alignItems: "center" }}>
                    <input
                            value={seal}
                      onChange={(e) =>
                              updateSealNumber(i, sealIdx, e.target.value)
                            }
                            style={{
                              ...wagonTableStyles.input,
                              padding: "6px",
                              flex: 1,
                              backgroundColor: sealIdx < w.seal_numbers.length - 1 ? "#d4edda" : "transparent",
                            }}
                          />
                          {w.seal_numbers.length > 1 && (
                            <button
                              onClick={() => removeSealNumber(i, sealIdx)}
                              style={{
                                background: "#dc2626",
                                color: "white",
                                border: "none",
                                borderRadius: "2px",
                                cursor: "pointer",
                                fontSize: "10px",
                                padding: "3px 6px",
                                fontWeight: "bold",
                                minWidth: "20px",
                                height: "20px",
                                display: "flex",
                                alignItems: "center",
                                justifyContent: "center",
                              }}
                              title="Remove Seal Number"
                            >
                              ×
                            </button>
                          )}
                        </div>
                      ))}
                    </div>
                    <button
                      onClick={() => addSealNumber(i)}
                      style={{
                        position: "absolute",
                        bottom: "6px",
                        right: "6px",
                        background: "#2563eb",
                        color: "white",
                        border: "none",
                        borderRadius: "2px",
                        cursor: "pointer",
                        fontSize: "10px",
                        padding: "3px 6px",
                        fontWeight: "bold",
                        minWidth: "20px",
                        height: "20px",
                        display: "flex",
                        alignItems: "center",
                        justifyContent: "center",
                      }}
                      title="Add Seal Number"
                    >
                      +
                    </button>
                  </td>

                  <td style={wagonTableStyles.readOnlyCell}>{w.stoppage_time || "-"}</td>

                  <td style={wagonTableStyles.cell}>
                    <input
                      value={w.remarks}
                      onChange={(e) =>
                        updateWagon(i, "remarks", e.target.value)
                      }
                      style={wagonTableStyles.input}
                    />
                  </td>

                  {/* TOGGLE */}
                  <td style={{...wagonTableStyles.cell, padding: "16px 8px"}}>
                    <div
                      onClick={() => toggleStatus(i)}
                      style={{
                        width: "46px",
                        height: "24px",
                        backgroundColor: w.loading_status ? "#4CAF50" : "#ccc",
                        borderRadius: "24px",
                        position: "relative",
                        cursor: "pointer",
                        transition: "background-color 0.25s ease",
                        margin: "0 auto",
                      }}
                    >
                      <div
                        style={{
                          width: "20px",
                          height: "20px",
                          backgroundColor: "#fff",
                          borderRadius: "50%",
                          position: "absolute",
                          top: "2px",
                          left: w.loading_status ? "24px" : "2px",
                          transition: "left 0.25s ease",
                          boxShadow: "0 2px 5px rgba(0,0,0,0.3)",
                        }}
                      />
                    </div>
                  </td>

                </tr>
              ))}
            </tbody>
          </table>
        </div>

        <div style={{ display: "flex", justifyContent: "flex-end", marginTop: "15px" }}>
        <button
            style={getButtonStyle("add")}
          onClick={addWagon}
        >
          ➕ Add Wagon
        </button>
        </div>
      </div>

      {/* ================= FOOTER ================= */}
      <div style={{
        ...buttonGroupStyles.container, 
        margin: "30px 20px 20px",
        justifyContent: "flex-end"
      }}>
        <button
          style={getButtonStyle("cancel")}
          onClick={() => navigate("/dashboard")}
        >
          Cancel
        </button>

        <button style={getButtonStyle("save")} onClick={saveDraft}>
          Save (Draft)
        </button>

        <button style={getButtonStyle("proceed")} onClick={proceed}>
          Proceed
        </button>
      </div>
      <DraftSavePopup
        open={showDraftPopup}
        onClose={() => setShowDraftPopup(false)}
      />
      <MultipleRakeSerialPopup
        open={showMultipleRakePopup}
        onClose={() => setShowMultipleRakePopup(false)}
        onYes={handleMultipleRakeYes}
        onNo={handleMultipleRakeNo}
      />
      </div>
    </AppShell>
  );
}

/* ================= HELPERS ================= */

function HeaderField({ label, value, onChange, readOnly }) {
  return (
    <div style={fieldStyles.container}>
      <label style={fieldStyles.label}>{label}</label>
      <input
        value={value}
        readOnly={readOnly}
        onChange={(e) => onChange && onChange(e.target.value)}
        style={getInputStyle(readOnly)}
      />
    </div>
  );
}

export default TrainEdit;

const popupStyles = {
  overlay: {
    position: "fixed",
    inset: 0,
    backgroundColor: "rgba(0,0,0,0.35)",
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
    zIndex: 999,
  },

  modal: {
    backgroundColor: "#fff",
    padding: "24px 30px 32px",
    borderRadius: "10px",
    width: "420px",
    textAlign: "center",
    boxShadow: "0 10px 30px rgba(0,0,0,0.25)",
  },

  image: {
    width: "320px",
    height: "320px",
    marginTop: "-70px",
    marginBottom: "-140px",
    marginLeft: "23px",
    objectFit: "contain",
  },

  title: {
    fontSize: "22px",
    fontWeight: "700",
    marginBottom: "6px",
  },

  message: {
    fontSize: "14px",
    color: "#555",
    marginBottom: "24px",
  },

  button: {
    padding: "20px 30px",
    backgroundColor: "#0B3A6E",
    color: "#fff",
    border: "none",
    borderRadius: "4px",
    cursor: "pointer",
    fontSize: "14px",
  },
};

const confirmPopupStyles = {
  overlay: {
    position: "fixed",
    inset: 0,
    backgroundColor: "rgba(0,0,0,0.5)",
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
    zIndex: 1000,
  },
  modal: {
    backgroundColor: "#fff",
    borderRadius: "12px",
    overflow: "hidden",
    width: "450px",
    boxShadow: "0 10px 30px rgba(0,0,0,0.3)",
  },
  header: {
    backgroundColor: "#0B3A6E",
    color: "white",
    padding: "20px",
    fontSize: "18px",
    fontWeight: "700",
    textAlign: "center",
    borderRadius: "12px 12px 0 0",
  },
  body: {
    padding: "30px 20px",
    textAlign: "center",
  },
  question: {
    fontSize: "16px",
    fontWeight: "700",
    color: "#000",
    marginBottom: "30px",
    margin: "0 0 30px 0",
  },
  buttonGroup: {
    display: "flex",
    justifyContent: "center",
    gap: "20px",
  },
  button: {
    padding: "12px 40px",
    backgroundColor: "#808080",
    color: "white",
    border: "none",
    borderRadius: "8px",
    cursor: "pointer",
    fontSize: "16px",
    fontWeight: "500",
    minWidth: "100px",
    transition: "background-color 0.2s",
  },
};

const topGridStyles = {
  container: {
    display: "grid",
    gridTemplateColumns: "repeat(auto-fit, minmax(260px, 1fr))",
    gap: "20px",
    marginTop: "10px",
  },
};

const floatingField = {
  wrapper: {
    position: "relative",
    background: "#f4f4f4",
    border: "1.5px solid #000",
    borderRadius: "4px",
    padding: "22px 14px 12px",
  },
  label: {
    position: "absolute",
    top: "-10px",
    left: "10px",
    background: "#fff",
    padding: "0 6px",
    fontSize: "13px",
    fontWeight: "600",
  },
  input: {
    width: "100%",
    border: "none",
    outline: "none",
    background: "transparent",
    fontSize: "16px",
    textAlign: "center",
  },
};

const boxedFieldStyles = {
  wrapper: {
    position: "relative",
    border: "1.5px solid #000",
    borderRadius: "3px",
    padding: "22px 18px 14px",
    background: "#fff",
    minWidth: "260px",
  },

  label: {
    position: "absolute",
    top: "-10px",
    left: "14px",
    background: "#fff",
    padding: "0 8px",
    fontSize: "15px",
    fontWeight: "600",
  },

  input: {
    width: "100%",
    border: "none",
    outline: "none",
    background: "#fff",
    fontSize: "16px",
    textAlign: "center",
    fontWeight: "400",
  },

  select: {
    width: "100%",
    border: "none",
    outline: "none",
    background: "#fff",
    fontSize: "16px",
    textAlign: "center",
    fontWeight: "400",
    appearance: "none",
    cursor: "pointer",
  },
};

const wagonTableStyles = {
  container: {
    width: "100%",
    backgroundColor: "#FFFFFF",
    borderCollapse: "separate",
    borderSpacing: "1px 44.88px",
    tableLayout: "fixed",
  },

  header: {
    backgroundColor: "#0B3A6E",
    color: "white",
    padding: "14px 8px",
    fontSize: "11px",
    textAlign: "center",
    fontWeight: "600",
    border: "0.9px solid #000000",
    verticalAlign: "middle",
    position: "sticky",
    top: 0,
    zIndex: 10,
  },

  row: (index) => ({
    backgroundColor: "#FFFFFF",
  }),

  cell: {
    padding: "0",
    fontSize: "11px",
    textAlign: "center",
    border: "0.9px solid #000000",
    color: "#000000",
    verticalAlign: "middle",
  },

  readOnlyCell: {
    padding: "16px 8px",
    fontSize: "11px",
    textAlign: "center",
    border: "0.9px solid #000000",
    color: "#000000",
    verticalAlign: "middle",
    backgroundColor: "#dbdbdbff",
  },

  input: {
    width: "100%",
    padding: "16px 8px",
    fontSize: "11px",
    border: "none",
    textAlign: "center",
    outline: "none",
    backgroundColor: "transparent",
    boxSizing: "border-box",
  },

  select: {
    width: "100%",
    padding: "16px 8px",
    fontSize: "11px",
    border: "none",
    textAlign: "center",
    outline: "none",
    backgroundColor: "transparent",
    boxSizing: "border-box",
    cursor: "pointer",
    appearance: "none",
  },
};